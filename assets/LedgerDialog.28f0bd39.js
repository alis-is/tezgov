import{c as B,d as U,r as y,w as A,s as G,o as I,a as C,b as d,e as P,C as H,I as M,u as K,f as T,g as O,t as Q,F as w,n as L,L as $,T as F,_ as W,p as z,h as Z,i as j,j as Y}from"./main.a3e23e34.js";import{p as h,P as f,b as m,a as X}from"./taquito-utils.es6.d10e4807.js";import{b as q}from"./index.918801f1.js";function S(t,e,i,r){function s(n){return n instanceof i?n:new i(function(a){a(n)})}return new(i||(i=Promise))(function(n,a){function l(u){try{c(r.next(u))}catch(g){a(g)}}function E(u){try{c(r.throw(u))}catch(g){a(g)}}function c(u){u.done?n(u.value):s(u.value).then(l,E)}c((r=r.apply(t,e||[])).next())})}const D=230;function k(t){const e=[];t.split("/").forEach(s=>{let n=parseInt(s,10);Number.isNaN(n)||(s.length>1&&s[s.length-1]==="'"&&(n+=2147483648),e.push(n))});const r=Buffer.alloc(1+e.length*4);return r[0]=e.length,e.forEach((s,n)=>{r.writeUInt32BE(s,1+4*n)}),r}function J(t,e){return e===0?t=t.slice(1):(t[0]=2+(t[64]&1),t=t.slice(0,33)),t}function ee(t,e){let i=t;return typeof e<"u"&&(i=Buffer.from(e).toString("hex").concat(t)),i}function te(t,e){let i=0;for(;i!==e.length;){const r=i+D>=e.length?e.length-i:D,s=Buffer.alloc(r);e.copy(s,0,i,i+r),t.push(s),i+=r}return t}function ie(t){let e=!0;t[0]!==49&&t[0]!==48&&(e=!1),t[1]+4!==t.length&&(e=!1),t[2]!==2&&(e=!1);const i=t[3];t[4+i]!==2&&(e=!1);const r=5+i,s=t[r];return r+1+s+2!==t.length&&(e=!1),e}function N(t,e){const i=Buffer.alloc(32);i.fill(0);let r=e[t],s=t+1;return r>32&&(s+=r-32,r=32),e.copy(i,32-r,s,s+r),{buffer:i,idxValueStart:s,length:r}}class re extends Error{constructor(e){super(e),this.message=e,this.name="InvalidLedgerResponseError"}}class se extends Error{constructor(){super("Unable to retrieve Public Key from Ledger"),this.name="PublicKeyRetrievalError"}}class ne extends Error{constructor(){super("Unable to retrieve Public Key Hash from Ledger"),this.name="PublicKeyHashRetrievalError"}}var o;(function(t){t[t.ED25519=0]="ED25519",t[t.SECP256K1=1]="SECP256K1",t[t.P256=2]="P256"})(o||(o={}));class oe extends Error{constructor(e){super(`The derivation type ${e} is invalid. The derivation type must be DerivationType.ED25519, DerivationType.SECP256K1 or DerivationType.P256`),this.derivationType=e,this.name="InvalidDerivationTypeError"}}class ae extends Error{constructor(e){super(`The derivation path ${e} is invalid. The derivation path must start with 44'/1729`),this.derivationPath=e,this.name="InvalidDerivationPathError"}}class xe{constructor(e,i="44'/1729'/0'/0'",r=!0,s=o.ED25519){if(this.transport=e,this.path=i,this.prompt=r,this.derivationType=s,this.CLA=128,this.INS_GET_PUBLIC_KEY=2,this.INS_PROMPT_PUBLIC_KEY=3,this.INS_SIGN=4,this.FIRST_MESSAGE_SEQUENCE=0,this.LAST_MESSAGE_SEQUENCE=129,this.OTHER_MESSAGE_SEQUENCE=1,this.transport.setScrambleKey("XTZ"),!i.startsWith("44'/1729'"))throw new ae(i);if(!Object.values(o).includes(s))throw new oe(s.toString())}publicKeyHash(){return S(this,void 0,void 0,function*(){if(this._publicKeyHash||(yield this.publicKey()),this._publicKeyHash)return this._publicKeyHash;throw new ne})}publicKey(){return S(this,void 0,void 0,function*(){if(this._publicKey)return this._publicKey;const e=yield this.getLedgerPublicKey(),i=e[0],r=e.slice(1,1+i),s=J(r,this.derivationType),n=this.getPrefixes(),a=m(s,n.prefPk),l=m(q.hash(s,20),n.prefPkh);return this._publicKey=a,this._publicKeyHash=l,a})}getLedgerPublicKey(){return S(this,void 0,void 0,function*(){try{let e=this.INS_PROMPT_PUBLIC_KEY;return this.prompt===!1&&(e=this.INS_GET_PUBLIC_KEY),yield this.transport.send(this.CLA,e,this.FIRST_MESSAGE_SEQUENCE,this.derivationType,k(this.path))}catch{throw new se}})}secretKey(){return S(this,void 0,void 0,function*(){throw new X("Secret key cannot be exposed")})}sign(e,i){return S(this,void 0,void 0,function*(){const r=ee(e,i),s=Buffer.from(r,"hex");let n=[];n.push(k(this.path)),n=te(n,s);const a=yield this.signWithLedger(n);let l;if(this.derivationType===o.ED25519)l=a.slice(0,a.length-2).toString("hex");else{if(!ie(a))throw new re("Cannot parse ledger response");const c=N(3,a),u=c.idxValueStart+c.length+1,g=N(u,a);l=Buffer.concat([c.buffer,g.buffer]).toString("hex")}return{bytes:e,sig:m(l,h[f.SIG]),prefixSig:m(l,this.getPrefixes().prefSig),sbytes:e+l}})}signWithLedger(e){return S(this,void 0,void 0,function*(){let i=yield this.transport.send(this.CLA,this.INS_SIGN,this.FIRST_MESSAGE_SEQUENCE,this.derivationType,e[0]);for(let r=1;r<e.length;r++){const s=r===e.length-1?this.LAST_MESSAGE_SEQUENCE:this.OTHER_MESSAGE_SEQUENCE;i=yield this.transport.send(this.CLA,this.INS_SIGN,s,this.derivationType,e[r])}return i})}getPrefixes(){return this.derivationType===o.ED25519?{prefPk:h[f.EDPK],prefPkh:h[f.TZ1],prefSig:h[f.EDSIG]}:this.derivationType===o.SECP256K1?{prefPk:h[f.SPPK],prefPkh:h[f.TZ2],prefSig:h[f.SPSIG]}:{prefPk:h[f.P2PK],prefPkh:h[f.TZ3],prefSig:h[f.P2SIG]}}}const le=t=>B(()=>[e=>!!e||`${t} can not be empty!`,e=>/^44\'\/1729(\'\/[0-9]+)+\'$/.test(e)||e==="44'/1729'"||`Invalid ${t}!`]),x=t=>(z("data-v-32e9469d"),t=t(),Z(),t),ce={class:"center"},ue={class:"card z-depth-2"},de={class:"content"},he=x(()=>d("div",{class:"icon-wrap center pv-2"},[d("img",{src:j,width:"50"})],-1)),fe=x(()=>d("div",{class:"headline pv-3"},"Connect your Ledger",-1)),pe=x(()=>d("div",{class:"pt-1 space-1"},null,-1)),ve={key:1,class:"error-text pt-2"},_e=x(()=>d("div",{class:"pv-2 space-2",style:{"grid-row":"9","grid-colum":"1"}},null,-1)),Ee={class:"buttons pt-0 pb-2"},ge=U({__name:"LedgerDialog",props:{context:null},emits:["cancel","confirm"],setup(t,{emit:e}){const i=t,r=le("Derivation Path"),s=[{id:o.ED25519,label:o[o.ED25519]},{id:o.SECP256K1,label:o[o.SECP256K1]},{id:o.P256,label:o[o.P256]}],n=y(!1),a=y(s[0]),l=y("44'/1729'/0'/0'"),E=y(void 0),c=y(!1);let u=!1;A(()=>i.context.active,v=>{if(v)u=!1;else{c.value=!1,E.value=void 0;return}});const g=B(()=>c.value||G(r.value,v=>v(l.value)!==!0));let p;const R=async()=>{try{c.value=!0;const{LedgerSession:v}=await W(()=>import("./LedgerSession.5964f599.js"),["assets/LedgerSession.5964f599.js","assets/main.a3e23e34.js","assets/index.f3c3aa71.css","assets/SessionBase.b8bb2d73.js","assets/taquito-utils.es6.d10e4807.js","assets/index.918801f1.js","assets/taquito-local-forging.es6.408ecfeb.js"]);p=await v.create_transport();const _=await v.create(p,i.context.networkId,{rpc:i.context.rpc,derivationType:a.value.id,derivationPath:l.value});if(u&&_){_.logout();return}typeof i.context.confirm=="function"&&i.context.confirm(_),e("confirm",_)}catch(v){E.value=`Failed to login with ledger!
Error: ${v.message}`,p==null||p.close()}finally{c.value=!1}},V=()=>{u=!0,p==null||p.close(),typeof i.context.cancel=="function"&&i.context.cancel(),e("cancel")};return(v,_)=>(I(),C(F,{to:"#dialog"},[d("div",{class:L(["modal",{"modal-active":t.context.active}]),key:"ledgerDialog"},[d("div",ce,[d("div",ue,[d("div",de,[he,fe,P(H,{class:"custom-hd pb-2",label:"Use custom HD derivation path",modelValue:n.value,"onUpdate:modelValue":_[0]||(_[0]=b=>n.value=b)},null,8,["modelValue"]),n.value?(I(),C(M,{key:0,class:"deriv-path",modelValue:l.value,"onUpdate:modelValue":_[1]||(_[1]=b=>l.value=b),label:"Derivation Path",rules:K(r),"capitalize-label":!0},null,8,["modelValue","rules"])):T("",!0),pe,E.value?(I(),O("div",ve,Q(E.value),1)):T("",!0),_e,d("div",Ee,[P(w,{onClick:V,label:"Cancel"}),P(w,{class:L(["confirm-btn",{disabled:K(g)}]),onClick:R,label:"Connect"},null,8,["class"])])]),d("div",{class:L(["loader-wrap",{"loader-hidden":!c.value}])},[P($,{class:"loader","is-indeterminate":!0,label:"Please confirm operation on your ledger..."})],2)])])],2)]))}});const Se=Y(ge,[["__scopeId","data-v-32e9469d"]]),be=Object.freeze(Object.defineProperty({__proto__:null,default:Se},Symbol.toStringTag,{value:"Module"}));export{xe as L,be as a};
